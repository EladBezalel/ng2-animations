{"version":3,"file":"animation_compiler.js","sourceRoot":"","sources":["../../../../../../modules/@angular/compiler/src/animation/animation_compiler.ts"],"names":[],"mappings":"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","sourcesContent":["import {BaseException} from '../facade/exceptions';\nimport {ListWrapper, Map, StringMapWrapper} from '../facade/collection';\nimport {isPresent, isBlank} from '../facade/lang';\n\nimport {Identifiers} from '../identifiers';\nimport * as o from '../output/output_ast';\n\nimport {AUTO_STYLE} from '@angular/core';\nimport {ANY_STATE, EMPTY_STATE} from '../../core_private';\n\nimport {\n  AnimationParseError,\n  ParsedAnimationResult,\n  parseAnimationEntry\n} from './animation_parser';\n\nimport {CompileDirectiveMetadata} from \"../compile_metadata\";\n\nimport {\n  AnimationAst,\n  AnimationEntryAst,\n  AnimationStateAst,\n  AnimationStateDeclarationAst,\n  AnimationStateTransitionAst,\n  AnimationKeyframeAst,\n  AnimationStylesAst,\n  AnimationSequenceAst,\n  AnimationGroupAst,\n  AnimationStepAst,\n  AnimationAstVisitor\n} from './animation_ast';\n\nexport class CompiledAnimation {\n  constructor(public name: string, public fnStatement: o.Statement, public fnVariable: o.Expression) {}\n}\n\nexport class AnimationCompiler {\n  compileComponent(component: CompileDirectiveMetadata): CompiledAnimation[] {\n    var compiledAnimations: CompiledAnimation[] = [];\n    var index = 0;\n    component.template.animations.forEach(entry => {\n      var result = parseAnimationEntry(entry);\n      if (result.errors.length > 0) {\n        var errorMessage = '';\n        result.errors.forEach((error: AnimationParseError) => { errorMessage += \"\\n- \" + error.msg; });\n        // todo (matsko): include the component name when throwing\n        throw new BaseException(\n          `Unable to parse the animation sequence for \"${entry.name}\" due to the following errors: ` +\n          errorMessage);\n      }\n\n      var factoryName = `${component.type.name}_${entry.name}_${index}`;\n      index++;\n\n      var visitor = new _AnimationBuilder(entry.name, factoryName);\n      compiledAnimations.push(visitor.build(result.ast));\n    });\n    return compiledAnimations;\n  }\n}\n\nvar _ANIMATION_FACTORY_ELEMENT_VAR = o.variable('element');\nvar _ANIMATION_FACTORY_RENDERER_VAR = o.variable('renderer');\nvar _ANIMATION_CURRENT_STATE_VAR = o.variable('currentState');\nvar _ANIMATION_NEXT_STATE_VAR = o.variable('nextState');\nvar _ANIMATION_PLAYER_VAR = o.variable('player');\nvar _ANIMATION_START_STATE_STYLES_VAR = o.variable('startStateStyles');\nvar _ANIMATION_FINAL_STATE_STYLES_VAR = o.variable('finalStateStyles');\nvar _ANIMATION_STYLES_LOOKUP = o.variable('animationStateStyles');\nvar _ANIMATION_UTIL = o.importExpr(Identifiers.AnimationStyleUtil);\n\nclass _AnimationBuilder implements AnimationAstVisitor {\n  constructor(public animationName, public factoryName: string) {}\n\n  visitAnimationStyles(ast: AnimationStylesAst,\n                               stateMap: _AnimationBuilderStateMap): o.Expression {\n    var stylesEntries = ast.styles.map(entry => {\n      return o.literalMap(StringMapWrapper.keys(entry).map(key => [key, o.literal(entry[key])]));\n    });\n    return o.importExpr(Identifiers.AnimationStyles).instantiate([o.literalArr(stylesEntries)]);\n  }\n\n  visitAnimationKeyframe(ast: AnimationKeyframeAst,\n                         stateMap: _AnimationBuilderStateMap): o.Expression {\n    return o.importExpr(Identifiers.AnimationKeyframe).instantiate([\n      o.literal(ast.offset),\n      ast.styles.visit(this, stateMap)\n    ]);\n  }\n\n  visitAnimationStep(ast: AnimationStepAst, stateMap: _AnimationBuilderStateMap): o.Expression {\n    var startingStyles = ast.startingStyles.visit(this, stateMap);\n    var keyframes = ast.keyframes.map(keyframeEntry => keyframeEntry.visit(this, stateMap));\n    return _ANIMATION_FACTORY_RENDERER_VAR.callMethod('animate', [\n      _ANIMATION_FACTORY_ELEMENT_VAR,\n      startingStyles,\n      o.literalArr(keyframes),\n      o.literal(ast.duration),\n      o.literal(ast.delay),\n      o.literal(ast.easing)\n    ]);\n  }\n\n  visitAnimationSequence(ast: AnimationSequenceAst,\n                         stateMap: _AnimationBuilderStateMap): o.Expression {\n    var playerExprs = ast.steps.map(step => step.visit(this, stateMap));\n    return o.importExpr(Identifiers.AnimationSequencePlayer).instantiate([\n      o.literalArr(playerExprs)]);\n  }\n\n  visitAnimationGroup(ast: AnimationGroupAst, stateMap: _AnimationBuilderStateMap): o.Expression {\n    var playerExprs = ast.steps.map(step => step.visit(this, stateMap));\n    return o.importExpr(Identifiers.AnimationGroupPlayer).instantiate([\n      o.literalArr(playerExprs)]);\n  }\n\n  visitAnimationStateDeclaration(ast: AnimationStateDeclarationAst, stateMap: _AnimationBuilderStateMap): void {\n    var flatStyles: {[key: string]: string|number} = {};\n    ast.styles.styles.forEach(entry => {\n      StringMapWrapper.forEach(entry, (value, key) => {\n        if (value != AUTO_STYLE) {\n          flatStyles[key] = value;\n        }\n      });\n    });\n    stateMap.registerState(ast.stateName, flatStyles);\n  }\n\n  visitAnimationStateTransition(ast: AnimationStateTransitionAst, stateMap: _AnimationBuilderStateMap): any {\n    var playerExpr = ast.animation.visit(this, stateMap);\n    stateMap.registerState(ast.fromState);\n    stateMap.registerState(ast.toState);\n    return new o.IfStmt(\n      _ANIMATION_PLAYER_VAR.equals(o.NULL_EXPR)\n      .and(_compareToAnimationStateExpr(_ANIMATION_CURRENT_STATE_VAR, ast.fromState))\n      .and(_compareToAnimationStateExpr(_ANIMATION_NEXT_STATE_VAR, ast.toState)), [\n        _ANIMATION_FACTORY_RENDERER_VAR.callMethod('setElementStyles', [\n          _ANIMATION_FACTORY_ELEMENT_VAR,\n          _ANIMATION_UTIL.callMethod('clearStyles', [_ANIMATION_START_STATE_STYLES_VAR]),\n        ]).toStmt(),\n        _ANIMATION_PLAYER_VAR.set(playerExpr).toStmt()\n      ]);\n  }\n\n  visitAnimationEntry(ast: AnimationEntryAst, stateMap: _AnimationBuilderStateMap): any {\n    var EMPTY_MAP = o.literalMap([]);\n\n    var statements = [];\n    statements.push(_ANIMATION_PLAYER_VAR.set(o.NULL_EXPR).toDeclStmt());\n\n    var transitionStatements = [];\n    ast.definitions.forEach(def => {\n      var result = def.visit(this, stateMap);\n      // the declaration state will be applied later\n      if (!(def instanceof AnimationStateDeclarationAst)) {\n        transitionStatements.push(result);\n      }\n    });\n\n    var lookupMap = [];\n    StringMapWrapper.forEach(stateMap.states, (value, stateName) => {\n      var variableValue = EMPTY_MAP;\n      if (isPresent(value)) {\n        let styleMap = [];\n        StringMapWrapper.forEach(value, (value, key) => {\n          styleMap.push([key, o.literal(value)]);\n        });\n        variableValue = o.literalMap(styleMap);\n      }\n      lookupMap.push([stateName, variableValue]);\n    });\n\n    statements.push(\n      _ANIMATION_STYLES_LOOKUP.set(\n        _ANIMATION_UTIL.instantiate([o.literalMap(lookupMap)])\n      ).toDeclStmt());\n\n    statements.push(\n      _ANIMATION_START_STATE_STYLES_VAR.set(\n        _ANIMATION_STYLES_LOOKUP.callMethod('lookup', [_ANIMATION_CURRENT_STATE_VAR])\n      ).toDeclStmt());\n\n    statements.push(\n      _ANIMATION_FINAL_STATE_STYLES_VAR.set(\n        _ANIMATION_STYLES_LOOKUP.callMethod('lookup', [_ANIMATION_NEXT_STATE_VAR])\n      ).toDeclStmt());\n\n    statements = statements.concat(transitionStatements);\n\n    statements.push(\n      new o.IfStmt(_ANIMATION_PLAYER_VAR.equals(o.NULL_EXPR), [\n        _ANIMATION_FACTORY_RENDERER_VAR.callMethod('setElementStyles', [\n          _ANIMATION_FACTORY_ELEMENT_VAR,\n          _ANIMATION_UTIL.callMethod('clearStyles', [_ANIMATION_START_STATE_STYLES_VAR]),\n        ]).toStmt(),\n        _ANIMATION_PLAYER_VAR.set(\n          o.importExpr(Identifiers.NoOpAnimationPlayer).instantiate([])\n        ).toStmt()\n      ]));\n\n    statements.push(\n      _ANIMATION_PLAYER_VAR.callMethod('onDone', [\n        o.fn([], [\n          _ANIMATION_FACTORY_RENDERER_VAR.callMethod('setElementStyles', [\n            _ANIMATION_FACTORY_ELEMENT_VAR,\n            o.importExpr(Identifiers.AnimationStyleUtil).callMethod('balanceStyles', [\n              _ANIMATION_START_STATE_STYLES_VAR,\n              _ANIMATION_FINAL_STATE_STYLES_VAR\n            ])\n          ]).toStmt()\n        ])\n      ]).toStmt());\n\n    statements.push(new o.ReturnStatement(_ANIMATION_PLAYER_VAR));\n\n    return o.fn([\n      new o.FnParam(_ANIMATION_FACTORY_RENDERER_VAR.name, o.importType(Identifiers.Renderer)),\n      new o.FnParam(_ANIMATION_FACTORY_ELEMENT_VAR.name, o.DYNAMIC_TYPE),\n      new o.FnParam(_ANIMATION_CURRENT_STATE_VAR.name, o.DYNAMIC_TYPE),\n      new o.FnParam(_ANIMATION_NEXT_STATE_VAR.name, o.DYNAMIC_TYPE)\n    ], statements);\n  }\n\n  build(ast: AnimationAst): CompiledAnimation {\n    var stateMap = new _AnimationBuilderStateMap();\n    var fnStatement = ast.visit(this, stateMap).toDeclStmt(this.factoryName);\n    var fnVariable = o.variable(this.factoryName);\n    return new CompiledAnimation(this.animationName, fnStatement, fnVariable);\n  }\n}\n\nclass _AnimationBuilderStateMap {\n  private _states: {[key: string]: {[prop: string]: string|number}} = {};\n  get states() { return this._states; }\n  registerState(name: string, value: {[prop: string]: string|number} = null): void {\n    var existingEntry = this._states[name];\n    if (isBlank(existingEntry)) {\n      this._states[name] = value;\n    }\n  }\n}\n\nfunction _compareToAnimationStateExpr(value: o.Expression, animationState: string): o.Expression {\n  if (animationState == EMPTY_STATE) {\n    return value.equals(o.importExpr(Identifiers.uninitialized));\n  } else if (animationState == ANY_STATE) {\n    return o.not(value.equals(o.importExpr(Identifiers.uninitialized)));\n  } else {\n    return value.equals(o.literal(animationState));\n  }\n}\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}